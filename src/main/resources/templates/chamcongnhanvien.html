<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Chấm công nhân viên</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="home d-flex flex-column min-vh-100">
    <!-- HEADER -->
    <header class="home__header d-flex justify-content-between align-items-center px-3 py-2 border-bottom shadow-sm" style="font-size: 0.95rem;">
        <div class="d-flex align-items-center">
            <a th:href="@{/index}" class="d-flex align-items-center text-decoration-none text-dark">
                <img src="./anh/logo.png" alt="Logo" class="me-2" style="width: 40px; height: 40px;" />
                <div>
                    <strong style="font-size: 1rem;">Quản lý chấm công</strong>
                    <p class="mb-0" style="font-size: 0.8rem;">Chào mừng bạn!</p>
                </div>
            </a>
        </div>
        <a th:href="@{/}" class="text-danger text-decoration-none d-flex align-items-center" style="font-size: 0.9rem;">
            <i class="bi bi-box-arrow-right me-1"></i> <span>Đăng xuất</span>
        </a>
    </header>

<div class="container mt-5">
    <h2 class="mb-4 text-primary">Chấm công cho nhân viên</h2>

    <div class="card mb-5">
        <div class="card-body">
            <form id="chamCongForm">
                <div class="mb-3">
                    <label for="nhanVienId" class="form-label">Nhân viên</label>
                    <select id="nhanVienId" class="form-select" required>
                        <option value="">-- Chọn nhân viên --</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="ngayCham" class="form-label">Ngày chấm</label>
                    <input type="date" id="ngayCham" class="form-control" required>
                </div>

                <div class="mb-3">
                    <label for="trangThai" class="form-label">Trạng thái</label>
                    <select id="trangThai" class="form-select" required>
                        <option value="DI_LAM">Đi làm</option>
                        <option value="NGHI_CO_PHEP">Nghỉ có phép</option>
                        <option value="NGHI_KHONG_PHEP">Nghỉ không phép</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="congViecId" class="form-label">Công việc</label>
                    <select id="congViecId" class="form-select">
                        <option value="">-- Chọn công việc --</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="ghiChu" class="form-label">Ghi chú</label>
                    <input type="text" id="ghiChu" class="form-control">
                </div>

                <div class="d-flex justify-content-between">
                    <button type="submit" class="btn btn-success">Lưu</button>
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">Hủy</button>
                </div>
            </form>
        </div>
    </div>

    <h4 class="mb-3 text-secondary">Lịch sử chấm công</h4>
    <table class="table table-bordered table-striped" id="chamCongTable">
        <thead class="table-dark">
        <tr>
            <th>Nhân viên</th>
            <th>Ngày</th>
            <th>Trạng thái</th>
            <th>Công việc</th>
            <th>Ghi chú</th>
            <th>Hành động</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>
</div>
<script>
    const token = localStorage.getItem("token");
    let chamCongDangSuaId = null;

    async function loadNhanVienOptions() {
        const res = await fetch("/api/nhanvien", {
            headers: { "Authorization": "Bearer " + token }
        });
        if (res.ok) {
            const data = await res.json();
            const select = document.getElementById("nhanVienId");
            select.innerHTML = `<option value="">-- Chọn nhân viên --</option>`;
            data.forEach(nv => {
                const opt = document.createElement("option");
                opt.value = nv.id;
                opt.textContent = nv.ten;
                select.appendChild(opt);
            });
        }
    }

    async function loadCongViecOptions() {
        const res = await fetch("/api/congviec", {
            headers: { "Authorization": "Bearer " + token }
        });
        if (res.ok) {
            const data = await res.json();
            const select = document.getElementById("congViecId");
            select.innerHTML = `<option value="">-- Chọn công việc --</option>`;
            data.forEach(cv => {
                const opt = document.createElement("option");
                opt.value = cv.id;
                opt.textContent = cv.tenCongViec;
                select.appendChild(opt);
            });
        }
    }

    async function submitChamCong(event) {
        event.preventDefault();

        const nhanVienId = document.getElementById("nhanVienId").value;
        const ngayCham = document.getElementById("ngayCham").value;
        const trangThai = document.getElementById("trangThai").value;
        const congViecId = document.getElementById("congViecId").value;
        const ghiChu = document.getElementById("ghiChu").value;

        const body = { ngayCham, trangThai, ghiChu };

        if (trangThai === "DI_LAM") {
            if (!congViecId) {
                alert("Vui lòng chọn công việc khi đi làm.");
                return;
            }
            body.congViec = { id: parseInt(congViecId) };
        }

        let url, method;
        if (chamCongDangSuaId) {
            url = `/api/chamcong/${chamCongDangSuaId}`;
            method = "PUT";
        } else {
            url = `/api/chamcong/nhanvien/${nhanVienId}`;
            method = "POST";
        }

        const res = await fetch(url, {
            method,
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token
            },
            body: JSON.stringify(body)
        });

        if (res.ok) {
            alert(chamCongDangSuaId ? "Cập nhật thành công!" : "Đã chấm công!");
            resetForm();
            loadChamCongList();
        } else {
            const error = await res.text();
            alert("Lỗi: " + error);
        }
    }

    async function loadChamCongList() {
        const res = await fetch("/api/chamcong", {
            headers: { "Authorization": "Bearer " + token }
        });

        const tbody = document.querySelector("#chamCongTable tbody");
        tbody.innerHTML = "";

        if (res.ok) {
            const data = await res.json();
            data.forEach(item => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${item.nhanVien?.ten || "-"}</td>
                    <td>${item.ngayCham}</td>
                    <td>${item.trangThai}</td>
                    <td>${item.congViec?.tenCongViec || "-"}</td>
                    <td>${item.ghiChu || ""}</td>
                    <td>
                        <button class="btn btn-sm btn-warning me-2" onclick="editChamCong(${item.id})">Sửa</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteChamCong(${item.id})">Xóa</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
    }

    async function editChamCong(id) {
        const res = await fetch(`/api/chamcong/${id}`, {
            headers: { "Authorization": "Bearer " + token }
        });

        if (res.ok) {
            const cc = await res.json();
            chamCongDangSuaId = cc.id;
            document.getElementById("nhanVienId").value = cc.nhanVien?.id || "";
            document.getElementById("ngayCham").value = cc.ngayCham;
            document.getElementById("trangThai").value = cc.trangThai;
            document.getElementById("ghiChu").value = cc.ghiChu || "";
            document.getElementById("congViecId").value = cc.congViec?.id || "";
            window.scrollTo({ top: 0, behavior: "smooth" });
        }
    }

    async function deleteChamCong(id) {
        if (!confirm("Bạn có chắc muốn xóa chấm công này?")) return;

        const res = await fetch(`/api/chamcong/${id}`, {
            method: "DELETE",
            headers: { "Authorization": "Bearer " + token }
        });

        if (res.ok) {
            alert("Đã xóa!");
            loadChamCongList();
        } else {
            alert("Lỗi khi xóa chấm công.");
        }
    }

    function resetForm() {
        document.getElementById("chamCongForm").reset();
        chamCongDangSuaId = null;
    }

    document.getElementById("chamCongForm").addEventListener("submit", submitChamCong);

    loadNhanVienOptions();
    loadCongViecOptions();
    loadChamCongList();
</script>
</body>
</html>
